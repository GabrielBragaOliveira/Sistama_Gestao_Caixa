<p-toast></p-toast>

<p-toolbar styleClass="relatorio-filtros">
  <div class="p-toolbar-group-start filters-container">

    <div class="p-field">
      <label for="rangeDatas">Período</label>
      <p-calendar id="rangeDatas" [(ngModel)]="filtroRangeDatas" selectionMode="range" [readonlyInput]="true"
        placeholder="Início - Fim" dateFormat="dd/mm/yy">
      </p-calendar>
    </div>

    <div class="p-field">
      <label for="usuario">Usuário</label>
      <p-dropdown id="usuario" [options]="usuariosFiltro" [(ngModel)]="filtroUsuario" placeholder="Todos os Usuários"
        [showClear]="true">
      </p-dropdown>
    </div>

    <div class="p-field">
      <label for="valorMin">Valor Mín. (R$)</label>
      <p-inputNumber id="valorMin" [(ngModel)]="filtroValorMin" mode="currency" currency="BRL" locale="pt-BR">
      </p-inputNumber>
    </div>

    <div class="p-field">
      <label for="valorMax">Valor Máx. (R$)</label>
      <p-inputNumber id="valorMax" [(ngModel)]="filtroValorMax" mode="currency" currency="BRL" locale="pt-BR">
      </p-inputNumber>
    </div>
  </div>

  <div class="p-toolbar-group-end actions-container">
    <button pButton label="Limpar" class="p-button-secondary p-button-outlined" icon="pi pi-times"
      (click)="limparFiltros()"></button>

    <button pButton label="Aplicar Filtros" icon="pi pi-filter" (click)="aplicarFiltros()"></button>
  </div>
</p-toolbar>

<div class="charts-container p-3">
  <p-card header="Total de Vendas por Período">
    <p-chart type="bar" [data]="chartTotalVendas" [options]="chartOptions"></p-chart>
  </p-card>

  <p-card header="Movimentação por Produto">
    <p-dropdown [options]="produtosFiltro" 
              [(ngModel)]="filtroProdutoChart" 
              (onChange)="atualizarChartProduto($event.value)"placeholder="Selecione um produto">
  </p-dropdown>

    <p-chart type="line" [data]="chartEntradaSaida" [options]="chartOptions"></p-chart>
  </p-card>

  <p-card header="Vendas por Operador">
    <p-chart type="bar" [data]="chartVendasOperador" [options]="chartOptions"></p-chart>
  </p-card>
</div>

<div class="tabela-relatorio p-3">
  <p-table [value]="vendas" [paginator]="true" [rows]="10" dataKey="vendaId" responsiveLayout="scroll"
    [rowExpandMode]="'single'" (onRowExpand)="onVendaExpand($event)">

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 10%">Cód. Venda</th>
        <th>Data</th>
        <th>Vendedor</th>
        <th>E-mail</th>
        <th style="width: 15%">Valor Total</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-venda let-expanded="expanded">
      <tr [pRowToggler]="venda">
        <td>{{ venda.vendaId }}</td>
        <td>{{ venda.dataVenda | date:'dd/MM/yyyy' }}</td>
        <td>{{ venda.nome }}</td>
        <td>{{ venda.email }}</td>
        <td>{{ venda.valorTotal | currency:'BRL' }}</td>
      </tr>
    </ng-template>

    <ng-template pTemplate="rowexpansion" let-venda>

      <ng-container *ngIf="this.vendasDetalhas.get(venda?.vendaId) as detalhe; else loading">

        <tr>
          <td colspan="5">
            <div class="row-expansion-details p-3">

              <div class="detalhes-financeiros">
                <div>
                  <strong>Valor Recebido:</strong>
                  {{ detalhe?.venda?.valorRecebido | currency:'BRL' }}
                </div>
                <div>
                  <strong>Troco:</strong>
                  {{ detalhe?.venda?.troco | currency:'BRL' }}
                </div>
              </div>

              <h5>Itens da Venda</h5>

              <p-table [value]="detalhe?.venda?.itens ?? []" dataKey="id">

                <ng-template pTemplate="header">
        <tr>
          <th>Produto</th>
          <th style="width: 10%">Qtd.</th>
          <th style="width: 15%">Preço Unit.</th>
          <th style="width: 15%">Subtotal</th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
      <tr>
        <td>{{ item.nomeProduto }}</td>
        <td>{{ item.quantidade }}</td>
        <td>{{ item.precoUnitario | currency:'BRL' }}</td>
        <td>{{ item.subtotal | currency:'BRL' }}</td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4">Nenhum item encontrado.</td>
      </tr>
    </ng-template>

  </p-table>
</div>
</td>
</tr>

</ng-container>

</ng-template>

<ng-template #loading>
  <tr>
    <td colspan="5" style="text-align: center;">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem; margin: 1rem;"></i>
      <p>Buscando detalhes...</p>
    </td>
  </tr>
</ng-template>


</p-table>

</div>